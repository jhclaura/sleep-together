<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" /> {% for str in data.dependencies -%} {% autoescape false %}{{ str }}{% endautoescape %} {%- endfor %} {% for str in data.share -%} {% autoescape false %}{{ str }}{% endautoescape %} {%- endfor %}
    <!-- <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" /> -->
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-database.js"></script>
</head>

<body>
    {% for str in data.header -%} {% autoescape false %}{{ str }}{% endautoescape %} {%- endfor %}
    <div id="render-canvas" style="display:none;"></div>
    <script type="text/javascript" src="js/lib/three.js"></script>
    <script type="text/javascript" src="js/lib/Detector.js"></script>
    <script type="text/javascript">
    var fbConfig = {
        databaseURL: "https://sleep-together.firebaseio.com/"
    };
    firebase.initializeApp(fbConfig);
    var fbDatabase = firebase.database();
    var visitDataRef = fbDatabase.ref("totalVisit");
    var fireVisit = 0;
    visitDataRef.on("value", function(snapshot) {
        fireVisit = snapshot.val().visit_count;
        console.log("firevisit: " + fireVisit);
    });

    //device detection
    //source: http://stackoverflow.com/questions/3514784/what-is-the-best-way-to-detect-a-mobile-device-in-jquery
    var isMobile = false; //initiate as false
    var whichMobile = "";
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        isMobile = true;
    }
    console.log("isMobile: " + isMobile);

    // tell android or iOS
    if (/Android/i.test(navigator.userAgent)) {
        console.log("I'm android!");
        whichMobile = "android";
    }
    if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        console.log("I'm iOS!");
        whichMobile = "iOS_mobile";
    }

    // if it's desktop, create click.gif div for PointerlockAPI
    if (!isMobile) {
        var clickDiv = document.createElement('div');
        clickDiv.id = "blocker";
        clickDiv.style = "display: none;";
        document.getElementsByTagName("body")[0].appendChild(clickDiv);

        var fingerImg = document.createElement('img');
        fingerImg.setAttribute("src", "images/click.gif");
        fingerImg.setAttribute("width", "60");
        fingerImg.setAttribute("height", "60");
        var ins = document.createElement('div');
        ins.id = "instructions";
        ins.appendChild(fingerImg);

        clickDiv.appendChild(ins);
    }

    // DETECT
    if (!Detector.webgl) Detector.addGetWebGLMessage();

    //
    function byId(_id) {
        return document.getElementById(_id);
    }

    function byClass(_class) {
        return document.getElementsByClassName(_class);
    }

    var renderCanvas = byId("render-canvas");
    var blockerDiv = byId("blocker");

    renderCanvas.style.opacity = 0;
    </script>
    <div id="splashPage" style="display:block; position:absolute; top:65px;">
        <h1>Sleep Together</h1>
        <input type="text" id="playerName" placeholder="Who is this sleepyhead?" style="width:20em;height:2em"></input>
        <img id="loadingImg" src="images/loadingbox.gif" width="60" height="60" style="margin:0 auto; display:block;">
        <div id="loadingTxt" style="color:yellow">loading</div>
        <p></p>
        <a id="startLink" style="display:none;cursor:pointer;color:#0af5e1;" onclick="getNameToStart();">Start</a>
    </div>
    <div id="aboutPage" style="display:block; position:absolute;">
        <a clase="aboutLink" id="aboutPageTitle" style="cursor:pointer; text-decoration: underline; color:#fc81a6" onclick="ToggleAbout();">About (ΘL_Θ)</a>
        <a clase="aboutLink" id="instructionTitle" style="cursor:pointer; text-decoration: underline; color:#0ecbf9" onclick="ToggleInstruction();">Instruction (ΘL_Θ)</a>
        <!-- <a clase="aboutLink" href="http://about.dailylifevr.com" target='_blank'>Dev Blog</a> -->
        <div id="aboutPageDetail" style="display:none;">
            <p>Sleep Together is a virtual reality group experience for people to use before going to sleep. In 60 seconds, visitor (a.k.a. sleeper) will go through a series of ritual for sleep, with other sleepers floating in a comfy nest, breathing together.</p>
            <li>Creator: <a href="http://www.jhclaura.com/" target='_blank'>Laura Juo-Hsin Chen</a></li>
            <li>Co-Producers: <a href="https://www.nfb.ca/" target='_blank'>ONF/NFB</a> & <a href="https://www.arte.tv/fr/" target='_blank'>arte</a></li>
            <li>Inspired from a conversation with <a href="http://lav.io/" target='_blank'>Sam Lavigne</a>, for <a href="http://dailylifevr.com/" target='_blank'>Daily Life VR</a> of <a href="http://uselesspress.org/" target='_blank'>Useless Press</a></li>
            <li>Great support by <a href="http://andysigler.com/" target='_blank'>Andy Sigler</a></li>
            <li>Thank <a href="https://twitter.com/tojiro" target='_blank'>Brandon Jones</a> and <a href="https://twitter.com/vvuk" target='_blank'>Vladimir Vukicevic</a> for WebVR spec. <a href="http://smus.com/" target='_blank'>Boris Smus</a> for WebVR polyfill and boilerplate. <a href="https://twitter.com/mrdoob" target='_blank'>Ricardo Cabello</a> for THREE.js</li>
        </div>
        <div id="instructionDetail" style="display:none;">
            <!-- <img class="insImg" src="images/instructions/toPoop.jpg">
			<img class="insImg" src="images/instructions/toWalk.jpg">
			<img class="insImg" src="images/instructions/toVR.jpg"> -->
        </div>
    </div>
    <script>
    var final_statistic = {};
    final_statistic.eaterCount = 0;
    final_statistic.totalVisit = 0;
    final_statistic.totalChew = 0;
    final_statistic.totalHeart = 0;
    final_statistic.youChew = 0;
    final_statistic.meToOthers = {};
    final_statistic.othersToMe = {};
    var heartFromMeCount = 0;

    var loadingImg = byId("loadingImg");
    var loadingTxt = byId("loadingTxt");
    var startLink = byId("startLink");
    var playerNameInput = byId("playerName");

    var splashPage = byId("splashPage");
    // var finalBG = byId("finalBG");
    // var finalStat = byId("finalStat");

    var playerNName = "";
    var readyToStart = false;

    var getNameToStart = function() {

        if (playerNameInput.value == playerNName) {
            playerNName = "Anonymous";
        } else {
            playerNName = playerNameInput.value;
        }
        final_statistic.playerName = playerNName;

        renderCanvas.style.display = "inline";
        renderCanvas.style.opacity = 1;

        if (blockerDiv) blockerDiv.style.display = "-webkit-box";

        splashPage.style.display = "none";

        aboutPage.style.display = "none";
        aboutPage.style.height = '';
        aboutDetail.style.display = "none";
        aboutTitle.innerText = "About (↑)";
        showAbout = false;

        // superInit();
        // connectSocket();

        lateInit();
    }

    // ABOUT_PAGE
    var showAbout = false,
        showInstruction = false;
    var aboutDetail = byId("aboutPageDetail");
    var aboutTitle = byId("aboutPageTitle");
    var instructDetail = byId("instructionDetail");
    var instructTitle = byId("instructionTitle");
    // → ← ↑ ↓
    var ToggleAbout = function() {
        showAbout = !showAbout;

        if (showAbout) {
            if (showInstruction) ToggleInstruction();

            aboutDetail.style.display = "block";
            if (isMobile)
                aboutPage.style.height = '100%';

            aboutTitle.innerText = "About (◉L_◉)";
        } else {
            aboutDetail.style.display = "none";
            aboutPage.style.height = '';

            aboutTitle.innerText = "About (ΘL_Θ)";
        }
    }

    var ToggleInstruction = function() {
        showInstruction = !showInstruction;

        if (showInstruction) {
            if (showAbout) ToggleAbout();

            instructDetail.style.display = "block";
            instructTitle.innerText = "Instruction (◉L_◉)";
        } else {
            instructDetail.style.display = "none";
            instructTitle.innerText = "Instruction (ΘL_Θ)";
        }
    }
    ///////////

    window.addEventListener('keydown', myFakeEnter, false);

    function myFakeEnter(event) {
        if (!readyToStart) return;

        switch (event.keyCode) {
            case 13: //enter
                getNameToStart();
                window.removeEventListener('keydown', myFakeEnter, false);
                break;
        }
    }
    </script>
    <script type="text/javascript">
    var socket = null;
    var socketOpened = false;

    var host;
    var ws;
    var camID = 0,
        addNewPlayerYet = false;
    var updatePreviousPlayer = false;

    var whoIamInLife = -1,
        initEnvironment = false;
    var meInWorld = -1;
    var totalPplInWorldsCount = 0,
        totalVisitCount = 0;
    var fullhouse = false,
        showAniPpl = false,
        showAniPplNumber = 4,
        doPplAni = false;
    var fullHouseDef = 7;
    var strictToCelePplNumber = 3,
        strictToCele = false;

    var currentPplAmount = 0;

    var knowMyIndex = false;
    //
    var trulyFullyStart = false;

    function connectSocket() {
        currentPplAmount++;

        host = location.origin.replace(/^http/, 'ws');
        ws = new WebSocket(host);

        ws.onopen = function() {
            console.log("Our beds are connected!");

            /* Connect this new player to every player*/
            /* JUST ONCE! */
            // -MOVED- @DeviceControls.js for dynamically creation
        }

        ws.onmessage = function(msg) {

            if (isAllOver)
                return;

            var data = JSON.parse(msg.data);

            if (data.type != "index" && !trulyFullyStart) return;

            if (data.type == 'addNewPlayer') {

                // If this is not ME && processed by server
                if (data.id != whoIamInLife && data.camID > 0) {

                    // If we are in the same world, create player
                    if (data.worldId == meInWorld) {
                        console.log("Got a new player, id: " + data.id);

                        // Create Player
                        var newPlayerStartPos = new THREE.Vector3(data.playerStartX, data.playerStartY, data.playerStartZ);
                        var newPlayerStartRotY = data.playerStartRotY;

                        var newGuy = new PersonSleep(newPlayerStartPos, data.myHex, data.id, data.nname, null);

                        dailyLifePlayerDict[data.id] = newGuy;

                        currentPplAmount++;
                    }

                    // update sleeper counting of this world(nest) & total worlds
                    UpdatePplCount(Object.keys(dailyLifePlayerDict).length, data.totalCount, fireVisit);
                    totalPplInWorldsCount = data.totalCount;
                    totalVisitCount = fireVisit;

                    // final_statistic.pooperCount ++;
                    // final_statistic.totalVisit = totalVisitCount;
                }
            }

            // Index of ME in the world (assigned by server)
            // Get to know whom I am
            if (data.type == "index") {

                /* ONLY ONCE */
                if (!knowMyIndex) {

                    whoIamInLife = data.index;
                    meInWorld = data.worldId;
                    totalVisitCount = fireVisit;
                    final_statistic.totalVisit = totalVisitCount;

                    console.log("I am #" + whoIamInLife + " in the #" + meInWorld + " Sleep-Together world, with total visit: " + totalVisitCount);

                    AssignIndex();

                    knowMyIndex = true;
                }
            }

            var playerPosX, playerPosY, playerPosZ, playerRotY, playerQ, playerQ3;
            // update player ONLY IF we are in the same world
            if (data.type == "updatePlayer" && data.worldId == meInWorld) {
                playerPosX = data.playerPosX;
                playerPosY = data.playerPosY;
                playerPosZ = data.playerPosZ;
                playerRotY = data.playerRotY;
                playerQ = new THREE.Quaternion(data.playerQ._x, data.playerQ._y, data.playerQ._z, data.playerQ._w);

                if (dailyLifePlayerDict[data.index] && data.index != whoIamInLife) {
                    // v.2 interpolation
                    dailyLifePlayerDict[data.index].updateReal(playerPosX, playerPosY, playerPosZ, playerQ);
                }
            }

            // update chewing ONLY IF we are in the same world
            if (data.type == "chew" && data.worldId == meInWorld) {

                // only chew if it's not MY DATA, cuz I've already chew
                if (data.index != whoIamInLife) {

                    // if it's aim at someone, create heart
                    if (data.toWhom != -1) {
                        createHeart(data.index, data.toWhom);
                        // final_statistic.totalHeart ++;

                        // if the heart is to ME, display the message
                        if (data.toWhom == whoIamInLife) {
                            var h_f_n = dailyLifePlayerDict[data.index].nname;
                            firstGuy.wordBubble.visible = true;
                            firstGuy.wordTexture.clear('#dc5e64').drawText("You got a heart from " + h_f_n + " <3", undefined, 96, 'white');
                            setTimeout(function() {
                                firstGuy.wordTexture.clear();
                                firstGuy.wordBubble.visible = false;
                            }, 5000);

                            // if( final_statistic.othersToMe[ h_f_n ] == undefined ){
                            // 	final_statistic.othersToMe[ h_f_n ] = 1;
                            // } else {
                            // 	final_statistic.othersToMe[ h_f_n ] ++;
                            // }
                        }
                    }
                    // if it's NOT aim at someone
                    else {
                        // createPoop(poopPos, poopQ);

                        // final_statistic.totalPoop ++;

                        if (dailyLifePlayerDict[data.index])
                            dailyLifePlayerDict[data.index].chew();
                    }
                }
            }

            // GAZE_TO_MOVE, ONLY IF we are in the same world
            if (data.type == 'gazeLength' && data.worldId == meInWorld) {
                if (data.index != whoIamInLife && dailyLifePlayerDict[data.index]) {

                    dailyLifePlayerDict[data.index].gazeDotTargetLength = data.length;

                    if (data.length == -1) {
                        dailyLifePlayerDict[data.index].resetGazeDots();
                    } else {
                        dailyLifePlayerDict[data.index].setGazeDotsRotation(dailyLifePlayerDict[data.target].player.position);
                    }
                }
            }

            // GAZE_TO_MOVE, ONLY IF we are in the same world
            if (data.type == 'gaze' && data.worldId == meInWorld) {
                if (data.index != whoIamInLife && dailyLifePlayerDict[data.index]) {
                    if (data.toWhom == -1) {
                        dailyLifePlayerDict[data.index].closeEye();
                        dailyLifePlayerDict[data.index].resetGazeDots();

                        // someone stop look at me
                        if (data.index == someoneLookingAtMe) {
                            firstGuy.wordTexture.clear();
                            firstGuy.wordBubble.visible = false;
                            someoneLookingAtMe = -1;
                        }
                    } else {
                        dailyLifePlayerDict[data.index].openEye();

                        // someone look at me
                        if (data.toWhom == whoIamInLife) {
                            var h_f_n = dailyLifePlayerDict[data.index].nname;
                            firstGuy.wordBubble.visible = true;
                            firstGuy.wordTexture.clear('#dc5e64').drawText(h_f_n + " is gazing at you <3", undefined, 96, 'white');

                            someoneLookingAtMe = data.index;

                            // setTimeout(function(){
                            // 	firstGuy.wordTexture.clear();
                            // },5000);
                        }
                    }
                }
            }

            // UPDATE_TIME
            if (data.type == 'timestamp') {
                if (data.worldId == meInWorld && dailyLifePlayerDict[data.index]) {
                    dailyLifePlayerDict[data.index].updateTimetag(data.time);
                    dailyLifePlayerDict[data.index].sleeperOrigin = data.origin;
                }
            }

            // BREATHING, TODO: what if in the middle of breathing in history player?
            if (data.type == 'startBreathing' && data.index != whoIamInLife) {
                if (data.worldId == meInWorld && dailyLifePlayerDict[data.index]) {
                    dailyLifePlayerDict[data.index].prepForBreathing();
                    dailyLifePlayerDict[data.index].startBreathing(data.redo);
                }
            }

            //REMOVE_PLAYER
            if (data.type == 'removePlayer') {
                if (data.worldId == meInWorld) {
                    removePlayer(data.removeID);
                    console.log('removePlayer #' + data.removeID);
                }
                console.log("removed; total: " + Object.keys(dailyLifePlayerDict).length);
                UpdatePplCount(Object.keys(dailyLifePlayerDict).length, data.totalCount, fireVisit);
                totalPplInWorldsCount = data.totalCount;
            }

            // ADD_HISTORY_PLAYERS
            // ONE_TIME_EVENT_IN_THE_BEGINNING
            if (data.length > 0 && !updatePreviousPlayer) {

                for (var i = 0; i < data.length; i++) {
                    // console.log("whoIamInLife: " + whoIamInLife + ", get history - id #" + data[i].id + " in world #" + data[i].worldId );

                    // if I'm not the coming player && we are in the same world
                    // this is a history player I want to create!!!
                    if (whoIamInLife != data[i].id && data[i].worldId == meInWorld) {

                        // if(dailyLifePlayerDict[ data[i].id ]){
                        // 	console.log("already exit, so not create history players #" + data[i].id + ", in world #" + data[i].worldId);
                        // } else {
                        var oldPlayerStartPos = new THREE.Vector3(data[i].playerStartX, data[i].playerStartY, data[i].playerStartZ);
                        var oldPlayerStartRotY = data[i].playerStartRotY;
                        var oldHex = data[i].myHex;
                        var oldPlayerID = data[i].id;
                        var oldPlayerName = data[i].nname;

                        // var oldPlayer = new Person( oldPlayerStartPos, oldHex, oldPlayerID, oldPlayerName );
                        // var oldPlayer = new PersonEat( oldPlayerStartPos, new THREE.Color(), oldPlayerID, oldPlayerName, mouth );
                        var oldPlayer = new PersonSleep(oldPlayerStartPos, oldHex, oldPlayerID, oldPlayerName);

                        dailyLifePlayerDict[oldPlayerID] = oldPlayer;
                        console.log("create history players #" + data[i].id + ", in world #" + data[i].worldId);
                        // }															
                    }                    
                    totalPplInWorldsCount = data[i].totalCount;
                }
                UpdatePplCount( Object.keys(dailyLifePlayerDict).length, totalPplInWorldsCount, fireVisit );
                totalVisitCount = fireVisit;
                updatePreviousPlayer = true;
            }
        }
        socketOpened = true;
    }

    //SYNCING_ISSUE
    //http://stackoverflow.com/questions/23898477/tornado-websockets-invalidstateerror-still-in-connecting-state
    //but has better solution... e.g. promises
    function sendMessage(msg) {
        waitForSocketConnection(ws, function() {
            ws.send(msg);
        });
    };

    function waitForSocketConnection(socket, callback) {
        setTimeout(
            function() {
                if (socket.readyState === 1) {
                    if (callback !== undefined) {
                        callback();
                    }
                    return;
                } else {
                    waitForSocketConnection(socket, callback);
                }
            }, 5);
    };

    function reloadPage() {
        location.reload(true);
    }
    </script>
    <!-- WebVR Boilerplate -->
    <script src="js/lib/effects/VREffect.js"></script>
    <script src="js/lib/webvr-polyfill.js"></script>
    <script src="js/lib/webvr-manager.js"></script>
    <script type="text/javascript" src="js/lib/howler.js"></script>
    <!-- <script type="text/javascript" src="js/lib/SPE.min.js"></script> -->
    <script type="text/javascript" src="js/lib/BufferLoader.js"></script>
    <!-- <script type="text/javascript" src="js/lib/physi.js"></script> -->
    <!-- <script type="text/javascript" src="js/lib/ImprovedNoise.js"></script> -->
    <script type="text/javascript" src="js/lib/TweenMax.min.js"></script>
    <!-- <script type="text/javascript" src="js/util/EndArrayPlugin.js"></script> -->
    <script type="text/javascript" src="js/lib/stats.min.js"></script>
    <script type="text/javascript" src="js/lib/threex.dynamictexture.js"></script>
    <script type="text/javascript" src="js/sample.js"></script>
    <!-- <script type="text/javascript" src="js/wave.js"></script> -->
    <script type="text/javascript" src="js/personSleep.js"></script>
    <!-- <script type="text/javascript" src="js/AniObject.js"></script> -->
    <script type="text/javascript" src="js/controls/DeviceControls_vSleep.js"></script>
    <script type="text/javascript" src="js/script_functions.js"></script>
    <script type="text/javascript" src="js/setup_sleep.js"></script>
    <script type="text/javascript" src="js/loader_sleep.js"></script>
    <script type="text/javascript" src="js/script_vSleep.js"></script>
    {% for str in data.footer -%}
    <!-- {% autoescape false %}{{ str }}{% endautoescape %} -->
    {%- endfor %} {% for str in data.tag -%} {% autoescape false %}{{ str }}{% endautoescape %} {%- endfor %}
    <script>
    var frameworkJS = new Framework('{% autoescape false %}{{ data.export_to_js }}{% endautoescape %}');
    // frameworkJS.track("test_de_statistique"); //exemple de tag
    </script>
</body>

</html>